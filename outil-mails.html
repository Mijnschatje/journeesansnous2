<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Journée Sans Nous — Générateur de mails aux syndicats</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" />
  <style>
    :root{--brand:#ee4943;--brand-600:#d33e38;--ink:#0f172a;--muted:#475569;--line:#e5e7eb;--radius:16px}
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.6 'Manrope',sans-serif;color:var(--ink);background:#fafafa}
    a{color:var(--brand);text-decoration:none}
    header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--line);box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .wrap{max-width:1100px;margin:auto;padding:0 18px}
    .topbar{display:flex;justify-content:space-between;align-items:center;height:64px;flex-wrap:wrap;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--brand)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);cursor:pointer;font-family:inherit;font-size:14px;transition:all .2s;font-weight:600}
    .btn:hover{background:#f8f9fa;transform:translateY(-1px)}
    .btn.primary{background:var(--brand);border-color:var(--brand-600);color:#fff}
    .btn.primary:hover{background:var(--brand-600)}
    .btn.ghost{background:transparent;border-color:transparent}
    .btn.ghost:hover{background:#f8f9fa}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn i{font-size:14px}
    
    .ticker{background:var(--brand);color:#fff;overflow:hidden;white-space:nowrap}
    .ticker .track{display:inline-block;animation:scroll 60s linear infinite;padding:6px 0}
    @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
    
    .hero{background:linear-gradient(135deg,#fff 0%,#fff5f4 50%,#ffe8e6 100%);padding:60px 0;border-bottom:1px solid var(--line);position:relative;overflow:hidden}
    .hero::before{content:'';position:absolute;top:-50%;right:-10%;width:500px;height:500px;background:radial-gradient(circle,rgba(238,73,67,.1),transparent);border-radius:50%}
    .hero h1{color:var(--brand);font-size:clamp(28px,3.2vw,42px);line-height:1.2;margin:0;font-weight:800;display:flex;align-items:center;gap:14px}
    .hero .lede{color:var(--muted);margin:.6rem 0 0;font-size:17px}
    .step-num{display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;background:var(--brand);color:#fff;border-radius:50%;font-size:22px;font-weight:800;flex-shrink:0}
    
    /* Barre de progression */
    .progress-bar{background:#f1f5f9;height:8px;border-radius:999px;overflow:hidden;margin:20px 0}
    .progress-fill{background:linear-gradient(90deg,var(--brand),#ff6b6b);height:100%;transition:width .6s ease;border-radius:999px;position:relative}
    .progress-fill::after{content:'';position:absolute;top:0;right:0;bottom:0;width:30px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3));animation:shimmer 1.5s infinite}
    @keyframes shimmer{0%,100%{opacity:0}50%{opacity:1}}
    .progress-text{text-align:center;margin-top:8px;font-size:14px;font-weight:600;color:var(--brand)}
    
    main{max-width:900px;margin:auto;padding:24px 18px}
    
    .step-card{background:#fff;border:1px solid var(--line);border-radius:16px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.04);transition:box-shadow .2s}
    .step-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .step-head{display:flex;justify-content:space-between;align-items:center;padding:18px 20px;border-bottom:1px solid var(--line);background:#fafafa;border-radius:16px 16px 0 0}
    .step-head h2{margin:0;color:var(--brand);font-size:18px;display:flex;align-items:center;gap:10px}
    .step-num-small{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;background:var(--brand);color:#fff;border-radius:50%;font-size:14px;font-weight:800}
    .step-body{padding:20px}
    
    .form-group{margin-bottom:18px}
    .form-group:last-child{margin-bottom:0}
    label{display:block;font-weight:600;margin-bottom:6px;color:var(--ink);font-size:14px;display:flex;align-items:center;gap:8px}
    .field-check{display:none;color:#10b981;font-size:16px}
    .field-check.show{display:inline-block;animation:checkPop .3s ease}
    @keyframes checkPop{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
    .helper{color:var(--muted);font-size:13px;margin-top:4px;line-height:1.4}
    input,select,textarea{width:100%;padding:11px 13px;border:1px solid var(--line);border-radius:10px;background:#fff;outline:none;font-family:inherit;font-size:15px;transition:all .2s}
    input:focus,select:focus,textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(238,73,67,.1)}
    textarea{min-height:280px;resize:vertical;font-size:14px;line-height:1.6}
    select{cursor:pointer}
    
    .grid-2{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:680px){.grid-2{grid-template-columns:1fr 1fr}}
    
    .checkbox-group{display:flex;align-items:center;gap:10px;padding:12px;background:#f8f9fa;border-radius:10px;cursor:pointer;transition:background .2s}
    .checkbox-group:hover{background:#f1f3f5}
    .checkbox-group input[type="checkbox"]{width:auto;margin:0;cursor:pointer}
    .checkbox-group label{margin:0;cursor:pointer;font-weight:500}
    
    #mandat-details{display:none;margin-top:10px}
    #mandat-details.show{display:block}
    
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    @media(max-width:680px){.actions{flex-direction:column}}
    
    .note{border-left:4px solid var(--brand);background:#fff2f1;padding:12px 14px;border-radius:10px;font-size:14px;line-height:1.5;position:relative;overflow:hidden}
    .note::before{content:'💡';position:absolute;top:8px;right:8px;font-size:20px;opacity:.3}
    .note strong{color:var(--brand)}
    
    .preview-box{white-space:pre-wrap;border:1px solid var(--line);border-radius:10px;padding:16px;background:#fafafa;font-size:14px;line-height:1.7;max-height:400px;overflow-y:auto;color:#334155}
    .preview-box.empty{color:var(--muted);font-style:italic;text-align:center;padding:40px 20px}
    
    .success-banner{background:#10b981;color:#fff;padding:12px 20px;border-radius:10px;display:none;align-items:center;gap:10px;margin-bottom:16px}
    .success-banner.show{display:flex}
    
    footer{color:#64748b;text-align:center;padding:40px 20px;border-top:1px solid var(--line);background:#fff;margin-top:60px}
    
    @media(max-width:680px){
      .topbar{height:auto;padding:12px 0}
      .step-head{flex-direction:column;align-items:flex-start;gap:12px}
      .step-head .actions{width:100%}
      .hero{padding:40px 0}
      /* ✅ CORRECTION: Réduire la marge à gauche sur mobile */
      main{margin-top:0;padding-left:18px;padding-right:18px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <div class="brand"><span>Journée Sans Nous</span></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <a class="btn ghost" href="./index.html"><i class="fa-solid fa-arrow-left"></i> Retour</a>
      </div>
    </div>
  </header>

  <div class="ticker"><div class="track">EN RÉGION PARISIENNE : lundi 17 novembre 19h–21h ➜ Assemblée publique – Bourse du Travail, 29 Bd du Temple, 75011 Paris • tous les lundis 19h ➜ Réunion d'organisation – 3 rue du Château d'Eau • À L'ÉCHELLE NATIONALE : jeudi 30 octobre 19h–21h ➜ Réunion en visio nationale des collectifs signataires de l'appel • EN RÉGION PARISIENNE : lundi 17 novembre 19h–21h ➜ Assemblée publique – Bourse du Travail, 29 Bd du Temple, 75011 Paris • tous les lundis 19h ➜ Réunion d'organisation – 3 rue du Château d'Eau</div></div>

  <section class="hero">
    <div class="wrap">
      <h1><span class="step-num">3</span> <span>Agir</span></h1>
      <p class="lede">Génère en 2 minutes un mail clair et percutant à ton syndicat, ta fédé ou ton UD pour rejoindre la mobilisation.</p>
    </div>
  </section>

  <main>
    <div>
      <!-- ÉTAPE 1 -->
    <div class="step-card">
      <div class="step-head">
        <h2><span class="step-num-small">1</span> Choisis ton syndicat</h2>
      </div>
      <div class="step-body">
        <div class="grid-2">
          <div class="form-group">
            <label for="syndicat">Syndicat * <span class="field-check" id="check-syndicat">✓</span></label>
            <select id="syndicat" required>
              <option value="">— Sélectionner —</option>
            </select>
          </div>
          <div class="form-group">
            <label for="dept">Département <span class="field-check" id="check-dept">✓</span></label>
            <select id="dept">
              <option value="">— Optionnel —</option>
            </select>
            <div class="helper">Union Départementale de ton département</div>
          </div>
          <div class="form-group">
            <label for="fede">Fédération (secteur) <span class="field-check" id="check-fede">✓</span></label>
            <select id="fede">
              <option value="">— Optionnel —</option>
            </select>
            <div class="helper">Fédération de ton secteur professionnel</div>
          </div>
          <div class="form-group">
            <label for="destinataire">Emails des destinataires * <span class="field-check" id="check-destinataire">✓</span></label>
            <input id="destinataire" type="text" placeholder="Les emails s'ajoutent automatiquement" required />
            <div class="helper">Les emails sélectionnés apparaissent ici, séparés par des virgules</div>
          </div>
        </div>
        <div class="form-group" style="margin-top:10px">
          <label for="cc">Copie (CC - optionnel) <span class="field-check" id="check-cc">✓</span></label>
          <input id="cc" type="text" placeholder="Emails supplémentaires en copie..." />
          <div class="helper">Les emails en surplus s'ajoutent ici</div>
        </div>
      </div>
    </div>

    <!-- ÉTAPE 2 -->
    <div class="step-card">
      <div class="step-head">
        <h2><span class="step-num-small">2</span> Tes informations</h2>
      </div>
      <div class="step-body">
        <div class="grid-2">
          <div class="form-group">
            <label for="nom">Nom / Prénom * <span class="field-check" id="check-nom">✓</span></label>
            <input id="nom" placeholder="Ton nom ou collectif" required />
          </div>
          <div class="form-group">
            <label for="lieu">Ville / Lieu de travail * <span class="field-check" id="check-lieu">✓</span></label>
            <input id="lieu" placeholder="Paris 20e, entrepôt X..." required />
          </div>
        </div>
        
        <div class="form-group">
          <div class="checkbox-group" onclick="document.getElementById('hasMandat').click()">
            <input type="checkbox" id="hasMandat" onclick="event.stopPropagation()">
            <label for="hasMandat">J'ai un mandat syndical</label>
          </div>
          <div id="mandat-details">
            <input id="mandat" placeholder="Ex : délégué·e syndical·e, élu·e CSE..." style="margin-top:10px" />
            <div class="helper">Précise ton mandat pour renforcer ta légitimité</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ÉTAPE 3 -->
    <div class="step-card">
      <div class="step-head">
        <h2><span class="step-num">3</span> Personnalise le message</h2>
      </div>
      <div class="step-body">
        <div class="form-group">
          <label for="sujet">Objet de l'email <span class="field-check" id="check-sujet">✓</span></label>
          <input id="sujet" value="Appel à la mobilisation du 18 décembre – Journée Sans Nous : pour une grève solidaire et politique" />
        </div>
        
        <div class="form-group">
          <label for="message">Corps du message (modifiable si besoin)</label>
          <textarea id="message" placeholder="Le message se génère automatiquement avec tes informations..."></textarea>
        </div>
        <div class="note">
          <strong>💡 Le message se remplit automatiquement</strong> avec tes informations. Tu peux le modifier directement dans la zone de texte si tu veux le personnaliser davantage.
        </div>
      </div>
    </div>

    <!-- ÉTAPE 4 -->
    <div class="step-card">
      <div class="step-head">
        <h2><span class="step-num">4</span> Vérifier et envoyer</h2>
      </div>
      <div class="step-body">
        <div class="form-group">
          <label>Aperçu du message</label>
          <div id="preview" class="preview-box empty">Charge le modèle pour voir l'aperçu...</div>
        </div>
        
        <div class="actions" style="margin-top:16px;display:flex;flex-direction:column;align-items:center;gap:12px">
          <button class="btn primary" id="btnMailto" style="width:100%;max-width:300px;justify-content:center">📧 Envoyer le mail</button>
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
            <button class="btn" id="btnCopier">📋 Copier</button>
            <button class="btn" id="btnTelecharger">💾 Télécharger</button>
          </div>
        </div>
        
        <div class="note" style="margin-top:12px">
          <strong>📧 Comment envoyer :</strong><br>
          • <strong>"Envoyer le mail"</strong> : ouvre automatiquement ton application mail (Gmail, Outlook, etc.) avec tout pré-rempli<br>
          • <strong>"Copier"</strong> : copie juste le texte pour le coller où tu veux<br>
          • <strong>"Télécharger"</strong> : sauvegarde le message en fichier texte
        </div>
      </div>
    </div>
  </main>

  <footer><a href="https://www.marchedessolidarites.org" 
   target="_blank" 
   rel="noreferrer noopener" 
   class="footer-logo-link">
  <img src="assets/img/Marche_des_Solidarites_logo.svg" 
       alt="Logo Marche des Solidarités" 
       class="footer-logo">
</a>
</footer>

<script>
/* ===== Système de progression ===== */
function updateProgress(){
  const fields = {
    'syndicat': el('syndicat').value,
    'destinataire': el('destinataire').value,
    'nom': el('nom').value,
    'lieu': el('lieu').value,
    'sujet': el('sujet').value,
    'message': el('message').value
  };
  
  let completed = 0;
  const total = Object.keys(fields).length;
  
  // Compter les champs remplis
  Object.keys(fields).forEach(key => {
    if(fields[key] && fields[key].trim()){
      completed++;
      // Afficher la coche verte
      const check = document.getElementById(`check-${key}`);
      if(check) check.classList.add('show');
    } else {
      // Cacher la coche
      const check = document.getElementById(`check-${key}`);
      if(check) check.classList.remove('show');
    }
  });
  
  // Gérer les champs optionnels avec coches
  ['dept', 'fede', 'cc'].forEach(key => {
    const val = el(key).value;
    const check = document.getElementById(`check-${key}`);
    if(check){
      if(val && val.trim()){
        check.classList.add('show');
      } else {
        check.classList.remove('show');
      }
    }
  });
  
  const percentage = Math.round((completed / total) * 100);
  
  // Mise à jour responsive : width sur desktop, height sur mobile
  const isMobile = window.innerWidth <= 768;
  const progressBar = el('progressBar');
  
  if(isMobile){
    progressBar.style.height = percentage + '%';
    progressBar.style.width = '100%';
  } else {
    progressBar.style.width = percentage + '%';
    progressBar.style.height = '100%';
  }
  
  el('progressText').textContent = percentage + '% complété';
  
  console.log(`Progression: ${completed}/${total} = ${percentage}%`);
}

/* ===== Animation confettis ===== */
function createConfetti(){
  const colors = ['#ee4943', '#fbbf24', '#3b82f6', '#10b981', '#f472b6', '#a78bfa'];
  const confettiCount = 50;
  
  for(let i = 0; i < confettiCount; i++){
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.setProperty('--confetti-color', colors[Math.floor(Math.random() * colors.length)]);
      confetti.style.left = Math.random() * 100 + '%';
      confetti.style.top = '-10px';
      confetti.style.opacity = '1';
      
      document.body.appendChild(confetti);
      
      const duration = 2000 + Math.random() * 1000;
      const rotation = Math.random() * 360;
      const drift = (Math.random() - 0.5) * 200;
      
      confetti.animate([
        { transform: 'translateY(0) rotate(0deg) translateX(0)', opacity: 1 },
        { transform: `translateY(${window.innerHeight + 20}px) rotate(${rotation}deg) translateX(${drift}px)`, opacity: 0 }
      ], {
        duration: duration,
        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
      }).onfinish = () => confetti.remove();
      
    }, i * 30);
  }
}

/* ===== Mapping départements ===== */
const DEPTS={"01":"Ain","02":"Aisne","03":"Allier","04":"Alpes-de-Haute-Provence","05":"Hautes-Alpes","06":"Alpes-Maritimes","07":"Ardèche","08":"Ardennes","09":"Ariège","10":"Aube","11":"Aude","12":"Aveyron","13":"Bouches-du-Rhône","14":"Calvados","15":"Cantal","16":"Charente","17":"Charente-Maritime","18":"Cher","19":"Corrèze","2A":"Corse-du-Sud","2B":"Haute-Corse","21":"Côte-d'Or","22":"Côtes-d'Armor","23":"Creuse","24":"Dordogne","25":"Doubs","26":"Drôme","27":"Eure","28":"Eure-et-Loir","29":"Finistère","30":"Gard","31":"Haute-Garonne","32":"Gers","33":"Gironde","34":"Hérault","35":"Ille-et-Vilaine","36":"Indre","37":"Indre-et-Loire","38":"Isère","39":"Jura","40":"Landes","41":"Loir-et-Cher","42":"Loire","43":"Haute-Loire","44":"Loire-Atlantique","45":"Loiret","46":"Lot","47":"Lot-et-Garonne","48":"Lozère","49":"Maine-et-Loire","50":"Manche","51":"Marne","52":"Haute-Marne","53":"Mayenne","54":"Meurthe-et-Moselle","55":"Meuse","56":"Morbihan","57":"Moselle","58":"Nièvre","59":"Nord","60":"Oise","61":"Orne","62":"Pas-de-Calais","63":"Puy-de-Dôme","64":"Pyrénées-Atlantiques","65":"Hautes-Pyrénées","66":"Pyrénées-Orientales","67":"Bas-Rhin","68":"Haut-Rhin","69":"Rhône","70":"Haute-Saône","71":"Saône-et-Loire","72":"Sarthe","73":"Savoie","74":"Haute-Savoie","75":"Paris","76":"Seine-Maritime","77":"Seine-et-Marne","78":"Yvelines","79":"Deux-Sèvres","80":"Somme","81":"Tarn","82":"Tarn-et-Garonne","83":"Var","84":"Vaucluse","85":"Vendée","86":"Vienne","87":"Haute-Vienne","88":"Vosges","89":"Yonne","90":"Territoire de Belfort","91":"Essonne","92":"Hauts-de-Seine","93":"Seine-Saint-Denis","94":"Val-de-Marne","95":"Val-d'Oise","971":"Guadeloupe","972":"Martinique","973":"Guyane","974":"La Réunion","975":"Saint-Pierre-et-Miquelon","976":"Mayotte","977":"Saint-Barthélemy","978":"Saint-Martin","986":"Wallis-et-Futuna","987":"Polynésie française","988":"Nouvelle-Calédonie"};

/* ===== Chargement de la base JSON ===== */
let DB={
  "CFDT": {"national": "paris@sgen.cfdt.fr", "ud": [], "fede": []},
  "CFTC": {"national": "organisation@cftc.fr", "ud": [], "fede": []},
  "Solidaires": {"national": "contact@solidaires.org", "ud": [], "fede": []},
  "CGT-FO": {"national": "secretariatnego@force-ouvriere.fr", "ud": [], "fede": []},
  "CFE-CGC": {"national": "pap@cfecgc.fr", "ud": [], "fede": []},
  "CGT": {"national": "site@cgt.org", "ud": [], "fede": []},
  "UNSA": {"national": null, "ud": [], "fede": []}
};

async function loadDB(){
  // Essayer plusieurs chemins possibles
  const urls = [
    'data/emails-syndicats.json',
    './data/emails-syndicats.json',
    '../data/emails-syndicats.json',
    '/journeesansnous/data/emails-syndicats.json',
    'https://mijnschatje.github.io/journeesansnous/data/emails-syndicats.json'
  ];
  
  for(const url of urls){
    try{
      console.log('🔍 Tentative de chargement:', url);
      const r = await fetch(url, {cache:'no-store'});
      if(r.ok){
        const data = await r.json();
        DB = data;
        console.log('✅ BASE CHARGÉE depuis:', url);
        console.log('📊 Syndicats:', Object.keys(DB));
        
        // Vérifier qu'on a bien des données
        Object.keys(DB).forEach(synd => {
          console.log(`  ${synd}: ${(DB[synd].ud||[]).length} départements, ${(DB[synd].fede||[]).length} fédérations`);
        });
        
        fillSyndicats();
        return true;
      }
    }catch(e){
      console.log('❌ Échec pour:', url, '-', e.message);
    }
  }
  
  console.warn('⚠️ ATTENTION: Impossible de charger la base de données');
  console.warn('📁 Assure-toi que le fichier emails-syndicats.json est dans un dossier "data/"');
  fillSyndicats();
  return false;
}

/* ===== Helpers ===== */
const el=id=>document.getElementById(id);

function fillSyndicats(){
  const s=el('syndicat'); 
  s.innerHTML='<option value="">— Sélectionner —</option>';
  const keys=Object.keys(DB).sort();
  console.log('Remplissage syndicats:', keys);
  keys.forEach(k=>s.add(new Option(k,k)));
  fillStructures();
}

function udSortKey(x){
  const c=(x.code||'').toUpperCase();
  const m=c.match(/^(\d+)([A-Z]?)$/);
  if(!m) return [9999,c];
  const n=parseInt(m[1],10);
  const frac=m[2]==='A'?0.1:(m[2]==='B'?0.2:0);
  return [n+frac,c];
}

function fillStructures(){
  const synd=el('syndicat').value;
  const dept=el('dept'); 
  const fede=el('fede');
  
  // Vider les selects
  dept.innerHTML='<option value="">— Optionnel —</option>';
  fede.innerHTML='<option value="">— Optionnel —</option>';

  if(!synd){
    console.log('❌ Aucun syndicat sélectionné');
    updateEmail();
    return;
  }

  const rec = DB[synd] || {};
  console.log('📋 Syndicat sélectionné:', synd);
  console.log('📊 Données brutes:', rec);
  
  const fedeList = rec.fede || [];
  const udList = rec.ud || [];
  
  console.log(`📦 Nombre de fédérations: ${fedeList.length}`);
  console.log(`📦 Nombre de départements: ${udList.length}`);

  // Remplir les fédérations
  if(fedeList.length > 0) {
    fedeList.forEach((x, index) => {
      const label = x.label || `Fédération ${index+1}`;
      const email = x.email || '';
      console.log(`  ➕ Fédé ${index+1}: ${label} → ${email}`);
      fede.add(new Option(label, email));
    });
    console.log(`✅ ${fedeList.length} fédérations ajoutées`);
  } else {
    console.log('⚠️ Aucune fédération disponible');
  }

  // Remplir les départements (triés)
  if(udList.length > 0) {
    const sortedUDs = udList.slice().sort((a,b) => {
      const [an, ac] = udSortKey(a);
      const [bn, bc] = udSortKey(b);
      return an - bn || ac.localeCompare(bc);
    });
    
    sortedUDs.forEach((x, index) => {
      const code = x.code || '';
      const email = x.email || '';
      const deptName = DEPTS[code] || '';
      const nice = (code && deptName) ? `${code} – ${deptName}` : (x.label || code || `UD ${index+1}`);
      console.log(`  ➕ Dépt ${index+1}: ${nice} → ${email}`);
      dept.add(new Option(nice, email));
    });
    console.log(`✅ ${sortedUDs.length} départements ajoutés`);
  } else {
    console.log('⚠️ Aucun département disponible');
  }

  console.log(`🎯 Remplissage terminé - Select Fédé: ${fede.options.length} options, Select Dépt: ${dept.options.length} options`);
  updateEmail();
}

function updateEmail(){
  const synd = el('syndicat').value;
  const deptVal = el('dept').value || '';
  const fedeVal = el('fede').value || '';
  
  if(!synd) {
    el('destinataire').value = '';
    el('cc').value = '';
    return;
  }
  
  const national = (DB[synd] || {}).national || '';
  
  // Collecter tous les emails sélectionnés
  const emails = [];
  
  // Ajouter dans l'ordre : National → Département → Fédération
  if (national) emails.push(national);
  if (deptVal) emails.push(deptVal);
  if (fedeVal) emails.push(fedeVal);
  
  console.log('Emails collectés:', emails);
  
  // Répartir les emails : le premier dans "destinataire", les autres dans "cc"
  if (emails.length > 0) {
    el('destinataire').value = emails[0];
    if (emails.length > 1) {
      el('cc').value = emails.slice(1).join(', ');
    } else {
      el('cc').value = '';
    }
  } else {
    el('destinataire').value = '';
    el('cc').value = '';
  }
  
  console.log('Destinataire:', el('destinataire').value);
  console.log('CC:', el('cc').value);
}

/* ===== Génération du modèle ===== */
function MODELE_OFFICIEL(){
  const nom=(el('nom').value||'').trim() || '[Prénom Nom]';
  const lieu=(el('lieu').value||'').trim() || '[Ville / Lieu de travail / Établissement]';
  const hasMandat=el('hasMandat').checked;
  const mandat=hasMandat ? (el('mandat').value||'').trim() : '';
  
  // Construction de la phrase selon le mandat
  let phraseMobilisation;
  if (hasMandat && mandat) {
    phraseMobilisation = `En tant que ${mandat}, je souhaite que mon lieu de travail puisse se joindre à cette mobilisation historique.`;
  } else {
    phraseMobilisation = `Je souhaite que mon lieu de travail puisse se joindre à cette mobilisation historique.`;
  }
  
  // Signature avec mandat si applicable
  let signature = `${nom}\n${lieu}`;
  if (hasMandat && mandat) {
    signature += `\nMandat : ${mandat}`;
  }
  
  return `Bonjour,

Je vous écris dans le cadre de la Journée Sans Nous – "Si on s'arrête, tout s'arrête !", organisée le 18 décembre 2025, à l'occasion de la Journée internationale des migrant·e·s.

À l'initiative des collectifs de personnes sans papiers, la Marche des Solidarités appelle à une grève générale solidaire à l'échelle nationale.
👉 L'appel complet : https://www.antiracisme-solidarite.org/18-d%C3%A9cembre-2025-journee-sans-nous

${phraseMobilisation}

Cette journée d'action me permettra de m'exprimer en solidarité avec les personnes immigrées et sans papiers, qui sont mes ami·es, mes voisin·es et mes collègues — celles et ceux qui font tourner le pays mais restent privé·es de droits, exploité·es dans des conditions indignes et constamment discriminé·es.

Aujourd'hui, les politiques racistes et inhumaines menées par l'État (rafles, enfermements en CRA, durcissement des lois sur l'immigration, atteintes aux droits sociaux) ne sont pas seulement une attaque contre les personnes étrangères : elles fragilisent tout le socle social en remettant en cause le droit du travail, en banalisant le travail dissimulé et l'exploitation humaine, en organisant une mise en concurrence destructrice entre salarié·es, et en affaiblissant la solidarité collective.

Face à cette urgence, nous avons besoin que les syndicats prennent position et ouvrent la voie à une grève politique et solidaire.

👉 Je vous demande :

• de vous prononcer publiquement en faveur de la Journée Sans Nous,
• d'informer vos adhérent·es et salarié·es sur la possibilité de se mobiliser le 18 décembre,
• et de mettre en œuvre les moyens légaux pour permettre une grève solidaire (préavis, communication, appui logistique…).

Cette journée sera l'occasion de manifester, débattre, fermer symboliquement nos lieux de travail, pour rappeler que la solidarité n'a pas de papiers.

Merci pour votre écoute et pour l'engagement que vous prendrez.
Je reste à votre disposition pour toute information complémentaire.

Solidairement,

${signature}
`;}

const MODELE_PREAVIS="Pour la Journée Sans Nous à l'occasion de la Journée internationale des Migrant.e.s 2025, nous appelons à une journée de grève pour exiger [revendication professionnelle claire, ex : régularisation par le travail / fin des contrôles discriminatoires / protection juridique pour travailleur·ses migrant·es] et pour dénoncer le racisme d'État qui nie ces droits.";

/* ===== Actions ===== */
function chargerModele(){
  el('message').value=MODELE_OFFICIEL();
  apercu();
  showSuccess();
}

function apercu(){
  const msg=el('message').value;
  const prev=el('preview');
  if(msg){
    prev.textContent=msg;
    prev.classList.remove('empty');
  }else{
    prev.textContent='Aucun message saisi.';
    prev.classList.add('empty');
  }
}

function copier(){
  const msg=el('message').value;
  if(!msg){alert('Charge d\'abord le modèle !');return;}
  navigator.clipboard.writeText(msg).then(()=>alert('✅ Message copié dans le presse-papiers !'));
}

function toMailto(){
  const to=el('destinataire').value||'';
  if(!to){alert('⚠️ Indique au moins un email destinataire !');return;}
  
  const cc=el('cc').value||'';
  const sujet=el('sujet').value||'Appel à la mobilisation du 18 décembre';
  const body=el('message').value||MODELE_OFFICIEL();
  const enc=s=>encodeURIComponent(s).replace(/%0A/g,'%0D%0A');
  
  // Construction de l'URL mailto avec gestion des multiples destinataires
  let url = `mailto:${encodeURIComponent(to)}?subject=${enc(sujet)}&body=${enc(body)}`;
  if(cc){
    url += `&cc=${encodeURIComponent(cc)}`;
  }
  
  // Animation confettis !
  createConfetti();
  
  // Petit délai pour voir les confettis avant d'ouvrir le mail
  setTimeout(() => {
    window.location.href=url;
  }, 500);
}

function telecharger(){
  const msg=el('message').value||MODELE_OFFICIEL();
  const blob=new Blob([msg],{type:'text/plain;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='mail-syndicat-journee-sans-nous.txt';
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ===== Event listeners ===== */
document.addEventListener('DOMContentLoaded',()=>{
  // Boutons
  el('btnCopier').onclick=copier;
  el('btnMailto').onclick=toMailto;
  el('btnTelecharger').onclick=telecharger;
  
  // Selects
  el('syndicat').onchange=fillStructures;
  el('dept').onchange=updateEmail;
  el('fede').onchange=updateEmail;
  
  // Mandat toggle
  el('hasMandat').onchange=e=>{
    el('mandat-details').classList.toggle('show',e.target.checked);
    chargerModele(); // Regénère le message
  };
  
  // Aperçu auto + régénération intelligente du message
  el('message').oninput=apercu;
  el('nom').oninput=chargerModele;
  el('lieu').oninput=chargerModele;
  el('mandat').oninput=chargerModele;
  
  // Init
  loadDB();
  chargerModele();
});
</script>
  <!-- Bouton de partage À ajouter juste avant </body> -->
<button class="share-button" id="shareButton">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="18" cy="5" r="3"></circle>
    <circle cx="6" cy="12" r="3"></circle>
    <circle cx="18" cy="19" r="3"></circle>
    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
  </svg>
  <span>Partager</span>
</button>

<style>
.share-button {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 9999;
  background: #ee4943;
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: 'Manrope', sans-serif;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(238, 73, 67, 0.4);
  transition: all 0.3s ease;
}

.share-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(238, 73, 67, 0.6);
  background: #d33e38;
}

.share-button:active {
  transform: translateY(0);
}

.share-button svg {
  width: 20px;
  height: 20px;
}

@media (max-width: 768px) {
  .share-button {
    bottom: 16px;
    right: 16px;
    padding: 10px 16px;
    font-size: 13px;
  }
  
  .share-button svg {
    width: 18px;
    height: 18px;
  }
}
</style>

<script>
document.getElementById('shareButton').addEventListener('click', function() {
  const shareText = "18 décembre 2025, Journée Internationale des Migrant.e.s, mettons-nous en grève solidaire avec les personnes sans papiers pour agir contre les lois racistes et les discriminations ➜ JOURNÉE SANS NOUS, Si on s'arrête, tout s'arrête !";
  const shareUrl = window.location.href;
  
  if (navigator.share) {
    // API native de partage (mobile)
    navigator.share({
      title: 'Journée Sans Nous - 18 décembre 2025',
      text: shareText,
      url: shareUrl
    }).catch(err => console.log('Partage annulé'));
  } else {
    // Fallback : copier dans le presse-papier
    const fullText = shareText + '\n\n' + shareUrl;
    navigator.clipboard.writeText(fullText).then(() => {
      // Feedback visuel
      const btn = document.getElementById('shareButton');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg><span>Copié !</span>';
      setTimeout(() => {
        btn.innerHTML = originalText;
      }, 2000);
    });
  }
});
</script>
</body>
</html>
